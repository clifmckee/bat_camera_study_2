---
title: "Community Resident Fruit Survey EDA"
author: "Kelly Endres"
date: "1/13/2022"
output: html_document
---

Rmarkdown file examining bat, human, and domestic animal fruit consumption behaviors in Bangladesh. Compares behaviors between Nipah virus case and control villages. 

This preliminary data analysis reviews the community resident survey given to the selected baris in each village. The survey assesses fruit consumption, related habits, and fruit trees. Thirty-one different types of fruits/fruit trees are included in the survey. 

Many questions address consumption of dropped fruits, which is used as a proxy for fruits potentially contaminated by bats. For example, if bats often visit a type of tree, and that tree's fruit is eaten off the ground, its possible that contaminated fruit is being consumed. 

Overview:  
1. Initial data observations  
2. Fruit consumption tables, by village type and tree type  
3. Fruit consumption graphs  
4. Additional fruit consumption questions  
5. Other  

### 1. Initial data observations

The following packages are used in analysis:
```{r load packages, message=FALSE}
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)
library(haven)
library(knitr)

options(scipen = 0)
```

Import cleaned dataset of community resident surveys. 
```{r import data}
fruit_survey <- readRDS(here("Data","community_resident_fruit_survey.RDS"))
```

Examine data structure
```{r}
head(fruit_survey)

# number of villages
### I switched from `q1_6` to `correct_villid`.
### The latter cleared up some of the issues with incorrect village IDs, e.g., "10" or "10061"
n_distinct(fruit_survey$correct_villid)
n_distinct(fruit_survey$dataid)

# villages by village type
fruit_survey %>% 
  group_by(case_control_group) %>% 
  summarise(villages_by_type = n_distinct(correct_villid))
  
# respondents per village
fruit_survey %>% 
  group_by(correct_villid) %>% 
  summarise(participants_per_village = n_distinct(dataid)) %>% 
  summary(participants_per_village)

  # Clif - why are there 3 observations with no data?
  ### Not sure why. They are blank in the original Stata file. We could ask Emily.
  ### I suspect they just planned on visiting that village but didn't go.
  fruit_survey[fruit_survey$correct_villid=="", ]
  
# respondents by village type
fruit_survey %>% 
  group_by(case_control_group) %>% 
  summarise(participants_per_villagetype = n_distinct(dataid))

# list of fruit names
fruit_names <- c("banana", "mango", "buroi", "sofeda", "guava", "date.palm",
                 "jackfruit", "lichhi", "custard.apple", "wood.apple", "elephant.apple",
                 "papaya", "watermelon", "melon", "cashew.fruit", "pomegranate", "palmyra",
                 "plum", "rose.apple", "indian.olive", "latkan", "monkey.jack", "uriam",
                 "rattan",  "river.ebony", "star.fruit", "wild.dates", "coconut", "betel",
                 "blackberry.jam", "water.chestnut")

# list of animal names
animal_names <- c("cattle", "buffalo", "goats", "pigs",
                  "sheep", "horses", "dogs", "cats")
```
  
Fruit survey dataset includes 206 villages and 5056 respondents. Of the 206 villages, 60 are case villages, 74 are far control, and 72 are near control. Their were 1473 respondents in case villages, 1815 from far control villages, and 1768 from near control villages. The median number of respondents per villages is 25 (min-max: 12-26).

#### 2. Fruit consumption by tree type

There are four main questions that assess fruit consumption by bari members, bats, and animals separated by tree type. 
- Do members of your bari eat any [insert fruit] off the ground? (q5_frt#_5_4)
- Do members of your bari eat any [insert fruit]? (q5_frt#_5_3)
- Do domestic mammals (cow,sheep,goat,pig,dog,cat)eat [insert fruit] jam off ground?
- Do bats eat any [insert fruit]?

Table of reported overall consumption by tree type for the above questions:

```{r human total dropped fruit consumption}
# create some vectors of column names for human dropped fruit consumption
dropped_fruit_cols <- paste0("q5_frt", seq(1:31), "_5_4")

# filter survey to just the dropped fruit columns and rename them with fruit names
h_dropped_fruit <- fruit_survey %>%
  select(case_control_group, all_of(dropped_fruit_cols))
colnames(h_dropped_fruit) <- c("case_control_group", fruit_names)

# make a table of dropped fruit statistics across all villages
h_dropped_total <- h_dropped_fruit %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(1:124),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(human_dropped_fruit = value)
```

```{r human total fruit consumption}
# create some vectors of column names for human fruit consumption
human_fruit_cols <- paste0("q5_frt", seq(1:31), "_5_3")

# filter survey to just the human fruit columns and rename them with fruit names
human_fruit <- fruit_survey %>%
  select(case_control_group, all_of(human_fruit_cols))
colnames(human_fruit) <- c("case_control_group", fruit_names)

# make a table of human fruit statistics across all villages
h_fruit_total <- human_fruit %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(1:124),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(human_fruit = value)
```

```{r animal total dropped fruit consumption}
# create some vectors of column names for animal dropped fruit consumption
animal_fruit_cols <- paste0("q5_frt", seq(1:31), "_5_5")

# filter survey to just the animal fruit columns and rename them with fruit names
a_dropped_fruit <- fruit_survey %>%
  select(case_control_group, all_of(animal_fruit_cols))
colnames(a_dropped_fruit) <- c("case_control_group", fruit_names)

# make a table of animal dropped fruit statistics across all villages
a_dropped_total <- a_dropped_fruit %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(1:124),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(animal_dropped_fruit = value)
```

```{r bat fruit consumption}
# create some vectors of column names for bat fruit consumption
bat_fruit_cols <- paste0("q5_frt", seq(1:31), "_5_5")

# filter survey to just the bat fruit columns and rename them with fruit names
bat_fruit <- fruit_survey %>%
  select(case_control_group, all_of(bat_fruit_cols))
colnames(bat_fruit) <- c("case_control_group", fruit_names)

# make a table of bat fruit statistics across all villages
b_fruit_total <- bat_fruit %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(1:124),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(bat_fruit = value)
```

```{r combine fruit consumption tables by tree type}
# join all the tables together and output to CSV
fruit_consumption <- full_join(h_fruit_total, h_dropped_total) %>%
  full_join(a_dropped_total) %>%
  full_join(b_fruit_total)
write.csv(fruit_consumption, here("Data","fruit_consumption.csv"))

# filter to just the mean and calculate the average proportion across all columns
fruit_consumption_mean <- fruit_consumption %>%
  filter(measure == "mean") %>%
  rowwise() %>% 
  mutate(average = mean(c_across(human_fruit:bat_fruit)))

# print a table
kable(fruit_consumption_mean %>%
        arrange(desc(average)) %>%
        select(-measure),
      digits = 3,
      caption = "Proportion of respondants reporting fruit consumption by bari members and bats and dropped fruit consumption by bari members and domestic animals (ranked by average across columns)")
```

Table of reported overall consumption by village type and tree type for the above questions:

```{r human dropped fruit consumption table by village type}
# make a table of dropped fruit statistics grouped by village type
h_dropped_grouped <- h_dropped_fruit %>%
  group_by(case_control_group) %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(2:125),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(human_dropped_fruit = value)
```

```{r human fruit consumption table by village type, echo=FALSE}
# make a table of human fruit statistics grouped by village type
h_fruit_grouped <- human_fruit %>%
  group_by(case_control_group) %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(2:125),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(human_fruit = value)
```

```{r animal dropped fruit consumption table}
# make a table of animal dropped fruit statistics grouped by village type
a_dropped_grouped <- a_dropped_fruit %>%
  group_by(case_control_group) %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(2:125),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(animal_dropped_fruit = value)
```

```{r bat dropped fruit consumption table}
# make a table of bat fruit statistics grouped by village type
b_fruit_grouped <- bat_fruit %>%
  group_by(case_control_group) %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(2:125),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(bat_fruit = value)
```

#### 4. Graphs 

```{r human dropped fruit consumption graph, echo=FALSE, fig.height = 5, fig.width = 10, fig.align = "center"}
# create a new object where average consumption across village types is ranked
rank_h_dropped_grouped_mean <- h_dropped_grouped %>%
  filter(measure == "mean") %>%
  group_by(fruit) %>%
  mutate(average = mean(human_dropped_fruit)) %>%
  arrange(desc(average)) %>%
  ungroup() %>%
  mutate(rank = dense_rank(desc(average)))

# pull out the ranked fruit names
rank_h_dropped_grouped_names <- rank_h_dropped_grouped_mean %>%
  distinct(fruit) %>%
  pull(fruit)

# plot human dropped fruit consumption with x-axis ranked by the average
rank_h_dropped_grouped_mean %>%
  filter(measure == "mean") %>%
  ggplot(aes(x = factor(rank), y = human_dropped_fruit, color = case_control_group)) +
  geom_jitter(height = 0, width = 0.2, alpha = 0.8) +
  scale_x_discrete(labels = rank_h_dropped_grouped_names) +
  labs(x = "Fruit type",
       y = "Proportion of baris with members\nconsuming fruit off ground",
       title = "Proportion of respondants reporting dropped fruit\nconsumption by bari members grouped by village type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(vjust = 1)) +
  scale_color_manual(
    name = "Village type",
    values = c(
      "case" = "#E69F00",
      "control, far" = "#56B4E9",
      "control, near" = "#009E73"
    )
  )
```

```{r human fruit consumption graph, echo=FALSE, fig.height = 5, fig.width = 10, fig.align = "center"}
# create a new object where average consumption across village types is ranked
rank_h_fruit_grouped_mean <- h_fruit_grouped %>%
  filter(measure == "mean") %>%
  group_by(fruit) %>%
  mutate(average = mean(human_fruit)) %>%
  arrange(desc(average)) %>%
  ungroup() %>%
  mutate(rank = dense_rank(desc(average)))

# pull out the ranked fruit names
rank_h_fruit_grouped_names <- rank_h_fruit_grouped_mean %>%
  distinct(fruit) %>%
  pull(fruit)

# plot human fruit consumption with x-axis ranked by the average
rank_h_fruit_grouped_mean %>%
  filter(measure == "mean") %>%
  ggplot(aes(x = factor(rank), y = human_fruit, color = case_control_group)) +
  geom_jitter(height = 0, width = 0.2, alpha = 0.8) +
  scale_x_discrete(labels = rank_h_fruit_grouped_names) +
  labs(x = "Fruit type",
       y = "Proportion of baris with members\nconsuming fruit",
       title = "Proportion of respondants reporting fruit\nconsumption by bari members by village type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(vjust = 1)) +
  scale_color_manual(
    name = "Village type",
    values = c(
      "case" = "#E69F00",
      "control, far" = "#56B4E9",
      "control, near" = "#009E73"
    )
  )
```

```{r animal dropped fruit consumption graph, fig.height = 5, fig.width = 10, fig.align = "center"}
# create a new object where average consumption across village types is ranked
rank_a_dropped_grouped_mean <- a_dropped_grouped %>%
  filter(measure == "mean") %>%
  group_by(fruit) %>%
  mutate(average = mean(animal_dropped_fruit)) %>%
  arrange(desc(average)) %>%
  ungroup() %>%
  mutate(rank = dense_rank(desc(average)))

# pull out the ranked fruit names
rank_a_dropped_grouped_names <- rank_a_dropped_grouped_mean %>%
  distinct(fruit) %>%
  pull(fruit)

# plot animal dropped fruit consumption with x-axis ranked by the average
rank_a_dropped_grouped_mean %>%
  filter(measure == "mean") %>%
  ggplot(aes(x = factor(rank), y = animal_dropped_fruit, color = case_control_group)) +
  geom_jitter(height = 0, width = 0.2, alpha = 0.8) +
  scale_x_discrete(labels = rank_a_dropped_grouped_names) +
  labs(x = "Fruit type",
       y = "proportion of baris with animals\nconsuming fruit off ground",
       title = "Proportion of respondants reporting animal consumption\nof dropped fruits by village type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(vjust = 1)) +
  scale_color_manual(
    name = "Village type",
    values = c(
      "case" = "#E69F00",
      "control, far" = "#56B4E9",
      "control, near" = "#009E73"
    )
  )
```

```{r bat fruit consumption graph, fig.height = 5, fig.width = 10, fig.align = "center"}
# create a new object where average consumption across village types is ranked
rank_b_fruit_grouped_mean <- b_fruit_grouped %>%
  filter(measure == "mean") %>%
  group_by(fruit) %>%
  mutate(average = mean(bat_fruit)) %>%
  arrange(desc(average)) %>%
  ungroup() %>%
  mutate(rank = dense_rank(desc(average)))

# pull out the ranked fruit names
rank_b_fruit_grouped_names <- rank_b_fruit_grouped_mean %>%
  distinct(fruit) %>%
  pull(fruit)

# plot bat fruit consumption with x-axis ranked by the average
rank_b_fruit_grouped_mean %>%
  filter(measure == "mean") %>%
  ggplot(aes(x = factor(rank), y = bat_fruit, color = case_control_group)) +
  geom_jitter(height = 0, width = 0.2, alpha = 0.8) +
  scale_x_discrete(labels = rank_b_fruit_grouped_names) +
  labs(x = "Fruit type",
       y = "Proportion of baris with bats\nconsuming fruit",
       title = "Proportion of respondants reporting bat consumption\nof fruits by village type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(vjust = 1)) +
  scale_color_manual(
    name = "Village type",
    values = c(
      "case" = "#E69F00",
      "control, far" = "#56B4E9",
      "control, near" = "#009E73"
    )
  )
```
Reported consumption of dropped fruits by bari members was highest for mango (76%), buroi (66%), guava (47%), and betel (38%). Consumption was lowest for melon (0%), water chestnut (0%), and uriam (0%). While reported dropped fruit consumption of date palm fruit was comparatively lower, at (21%), dropped date palm fruit consumption was highest among case villages by the largest difference of any fruit. Case village consumption of date palm fruit was reported to be 29%, control near 21%, and control far 16%. The average reported consumption among all fruits was 16%.

Reported consumption of fruits by bari members among fruit tree types was generally high (mean = 57%) with little difference in consumption between village types. Fruits consumed the most were mango (98%), jackfruit (96%), banana (96%), buroi (95%), and guava (94%). However, date palm fruit consumption was again highest among case villages by the largest difference of any fruit. Case village consumption of date palm fruit was reported to be 71%, control near 62%, and control far 52%.

Reported consumption of dropped fruits by domestic animals was much lower than human consumption (mean = 7%). Dropped fruit consumption was highest for mango (30%), buroi (27%), guava (21%), jackfruit (18%), and banana (15%). Date palm fruit consumption was 8% overall; 7% in case villages, 6% in near control villages, and 10% in far control villages. Difference in consumption between village types overall seems to vary more among domestic animals than humans, though this may be due to decreased accuracy in observations of animal fruit consumption compared to human fruit consumption.

Reported consumption of fruits by bats was on average 33%. This was highest for mango (90%), guava (84%), buroi (81%), and banana (82%). In each case consumption was slightly higher in case villages compared to near control villages, and higher in near control villages than far control villages. Date palm fruit consumption was 44% overall; 52% in case villages, 40% in near control villages, and 40% in far control villages.

Date palm fruit consumption was highest in case villages for bat fruit consumption, human fruit consumption, and human dropped fruit consumption. Dropped fruit consumption is a proxy for consumption of fruits that may have been bitten or contaminated by bats. However, the high reported consumption of mango, guava, and buroi by bats compared with high dropped fruit consumption of these fruits by humans and animals is potentially notable.

Additional comparison graphs are displayed for the 6 fruit species that had bat camera trap tree visits (banana, jujube aka buroi, guava, fig, star fruit, and sapodilla aka sofeda), as well as for date palm. 
  
**What is fig known as?**
_Clif: As far as I can tell, fig doesn't show up in the survey. The local name for fig is "dumur". Other fruit trees that show up in the camera data but not the survey data include tamarind ("tetul") and cotton tree ("shimul")._

```{r banana fruit consumption comparison, echo=FALSE, fig.height = 7, fig.width = 7, fig.align = "center"}
# join all the tables together and calculate the average proportion across all columns
fruit_consumption_grouped <- full_join(h_fruit_grouped, h_dropped_grouped) %>%
  full_join(a_dropped_grouped) %>%
  full_join(b_fruit_grouped)
write.csv(fruit_consumption_grouped, here("Data","fruit_consumption_grouped.csv"))

fruit_consumption_grouped %>%
  filter(
    measure == "mean",
    fruit %in% c("banana", "guava", "date.palm", "star.fruit", "sofeda", "buroi")
  ) %>%
  gather(human_fruit:bat_fruit, key = "subject", value = "proportion") %>%
  ggplot(aes(x = subject, y = proportion, color = case_control_group)) +
  geom_jitter(height = 0, width = 0.1, alpha = 0.8) +
  facet_grid(rows = vars(fruit)) +
  labs(x = "Consumption group",
       y = "Proportion reported consuming fruit",
       title = "Reported consumption by group by village type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(vjust = 1)) +
  scale_color_manual(
    name = "Village type",
    values = c(
      "case" = "#E69F00",
      "control, far" = "#56B4E9",
      "control, near" = "#009E73"
    )
  )
```

#### 4. Additional survey questions

There are several survey questions that provide additional insight into fruit consumption of humans, bats, and animals. 

Human fruit consumption questions:

```{r human dropped fruits, echo=FALSE}
# Are the fruits on the ground eaten by bari members? (q5_17)
fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q5_17)),
    numNA = sum(is.na(q5_17)),
    sum_households = sum(q5_17, na.rm = TRUE),
    response_rate = count / (count + numNA),
    proportion_households = mean(q5_17, na.rm = TRUE)
  )
```

```{r human dropped and bat bitten fruits p2, echo = FALSE}
# How often do compound members eat bat or bird bitten fruits? (q5_18)
unique(fruit_survey$q5_18)

kable(
  fruit_survey %>%
    group_by(case_control_group) %>%
    summarise(
      median_household = median(q5_18, na.rm = TRUE),
      mean_household = mean(q5_18, na.rm = TRUE),
      count = sum(!is.na(q5_18)),
      numNA = sum(is.na(q5_18)),
      response_rate = count / (count + numNA),
      sum_1 = sum(q5_18 == 1, na.rm = TRUE),
      prop_1 = mean(q5_18 == 1, na.rm = TRUE),
      sum_2 = sum(q5_18 == 2, na.rm = TRUE),
      prop_2 = mean(q5_18 == 2, na.rm = TRUE),
      sum_3 = sum(q5_18 == 3, na.rm = TRUE),
      prop_3 = mean(q5_18 == 3, na.rm = TRUE)
    ),
  digits = 3,
  caption = "Reported frequency of dropped fruit consumption by bari members"
)
```

Reported dropped fruit consumption by bari members was lowest in case villages, at 42%, compared to both categories of control villages. Of those who reported dropped fruit consumption, most stated only occasional consumption.

Domestic animals fruit consumption questions:

```{r additional info}
# Are the fruits on the ground eaten by domestic animals? (q5_19)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q5_19)),
    numNA = sum(is.na(q5_19)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_19, na.rm = TRUE),
    proportion_households = mean(q5_19, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q5_19)),
    numNA = sum(is.na(q5_19)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_19, na.rm = TRUE),
    proportion_households = mean(q5_19, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Proportion of respondants reporting feeding dropped fruit consumption to domestic animals in bari"
)

# Are bat or bird bitten fruit fed to domestic animals? (q5_21)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q5_21)),
    numNA = sum(is.na(q5_21)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_21, na.rm = TRUE),
    proportion_households = mean(q5_21, na.rm = TRUE))
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q5_21)),
    numNA = sum(is.na(q5_21)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_21, na.rm = TRUE),
    proportion_households = mean(q5_21, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Proportion of respondants reporting dropped fruit consumption by domestic animals in bari"
)

# How often is bat or bird bitten fruit fed to domestic animals? (q5_22)
unique(fruit_survey$q5_22)

fruit_survey %>%
  summarize(
      median_household = median(q5_22, na.rm = TRUE),
      mean_household = mean(q5_22, na.rm = TRUE),
      count = sum(!is.na(q5_22)),
      numNA = sum(is.na(q5_22)),
      response_rate = count / (count + numNA),
      sum_1 = sum(q5_22 == 1, na.rm = TRUE),
      prop_1 = mean(q5_22 == 1, na.rm = TRUE),
      sum_2 = sum(q5_22 == 2, na.rm = TRUE),
      prop_2 = mean(q5_22 == 2, na.rm = TRUE),
      sum_3 = sum(q5_22 == 3, na.rm = TRUE),
      prop_3 = mean(q5_22 == 3, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
    summarize(
      median_household = median(q5_22, na.rm = TRUE),
      mean_household = mean(q5_22, na.rm = TRUE),
      count = sum(!is.na(q5_22)),
      numNA = sum(is.na(q5_22)),
      response_rate = count / (count + numNA),
      sum_1 = sum(q5_22 == 1, na.rm = TRUE),
      prop_1 = mean(q5_22 == 1, na.rm = TRUE),
      sum_2 = sum(q5_22 == 2, na.rm = TRUE),
      prop_2 = mean(q5_22 == 2, na.rm = TRUE),
      sum_3 = sum(q5_22 == 3, na.rm = TRUE),
      prop_3 = mean(q5_22 == 3, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Reported frequency of bari members feeding dropped fruit to domestic animals"
)

# Is raw sap fed to animals? (q3_6_10)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q3_6_10)),
    numNA = sum(is.na(q3_6_10)),
    response_rate = count / (count + numNA),
    sum_households = sum(q3_6_10, na.rm = TRUE),
    proportion_households = mean(q3_6_10, na.rm = TRUE))
kable(fruit_survey %>%
  group_by(case_control_group) %>%
    summarize(
    count = sum(!is.na(q3_6_10)),
    numNA = sum(is.na(q3_6_10)),
    response_rate = count / (count + numNA),
    sum_households = sum(q3_6_10, na.rm = TRUE),
    proportion_households = mean(q3_6_10, na.rm = TRUE)),
  digits = 3,
  caption = "Proportion of respondants reporting feeding raw date palm sap to domestic animals in bari"
)

# Do you feed dirty sap to animals? (q3_11_2)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q3_11_2)),
    numNA = sum(is.na(q3_11_2)),
    response_rate = count / (count + numNA),
    sum_households = sum(q3_11_2, na.rm = TRUE),
    proportion_households = mean(q3_11_2, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q3_11_2)),
    numNA = sum(is.na(q3_11_2)),
    response_rate = count / (count + numNA),
    sum_households = sum(q3_11_2, na.rm = TRUE),
    proportion_households = mean(q3_11_2, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Proportion of respondants reporting feeding dirty raw date palm sap to domestic animals in bari"
)

# How often do you feed date palm sap to animals? (q3_12)
unique(fruit_survey$q3_12)

fruit_survey %>%
  summarize(
    median_household = median(q3_12, na.rm = TRUE),
    mean_household = mean(q3_12, na.rm = TRUE),
    count = sum(!is.na(q3_12)),
    numNA = sum(is.na(q3_12)),
    response_rate = count / (count + numNA),
    sum_1 = sum(q3_12 == 1, na.rm = TRUE),
    prop_1 = mean(q3_12 == 1, na.rm = TRUE),
    sum_2 = sum(q3_12 == 2, na.rm = TRUE),
    prop_2 = mean(q3_12 == 2, na.rm = TRUE),
    sum_3 = sum(q3_12 == 3, na.rm = TRUE),
    prop_3 = mean(q3_12 == 3, na.rm = TRUE),
    sum_4 = sum(q3_12 == 4, na.rm = TRUE),
    prop_4 = mean(q3_12 == 4, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    median_household = median(q3_12, na.rm = TRUE),
    mean_household = mean(q3_12, na.rm = TRUE),
    count = sum(!is.na(q3_12)),
    numNA = sum(is.na(q3_12)),
    response_rate = count / (count + numNA),
    sum_1 = sum(q3_12 == 1, na.rm = TRUE),
    prop_1 = mean(q3_12 == 1, na.rm = TRUE),
    sum_2 = sum(q3_12 == 2, na.rm = TRUE),
    prop_2 = mean(q3_12 == 2, na.rm = TRUE),
    sum_3 = sum(q3_12 == 3, na.rm = TRUE),
    prop_3 = mean(q3_12 == 3, na.rm = TRUE),
    sum_4 = sum(q3_12 == 4, na.rm = TRUE),
    prop_4 = mean(q3_12 == 4, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Reported frequency of bari members feeding date palm sap to domestic animals"
)

# Have you heard of other people in the village feeding sap to animals? (q3_13)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q3_13)),
    numNA = sum(is.na(q3_13)),
    response_rate = count / (count + numNA),
    sum_households = sum(q3_13, na.rm = TRUE),
    proportion_households = mean(q3_13, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q3_13)),
    numNA = sum(is.na(q3_13)),
    response_rate = count / (count + numNA),
    sum_households = sum(q3_13, na.rm = TRUE),
    proportion_households = mean(q3_13, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Proportion of respondants reporting other people in the village feeding dirty raw date palm sap to domestic animals in their bari"
)
```

Consumption of fruits on the ground by animals 30%, and is lowest in case villages at 22%. Feeding bat or bird bitten fruits to domestic animals is less common (20%), but is again lowest in case villages at 15%. Among those who reported feeding these to domestic animals the behavior was reported to be most often done only occasionally in all village types.

Interestingly, more respondents reported that raw date palm sap and dirty sap is fed to domestic animals in near control villages compared to far control or case villages. However, in far control and case villages date palm sap is fed to animals most often daily compared to about once per week in near control villages.

An important thing to note, however, is that response rate for some of these questions is much lower than the questions about fruit trees. For example, question `q3_12` about feeding sap to animals had a response rate of only 0.44%.

Bat fruit consumption questions:

```{r other info}
# Do you ever see fruits from the trees on the ground bitten by bats or birds? (q5_14)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q5_14)),
    numNA = sum(is.na(q5_14)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_14, na.rm = TRUE),
    proportion_households = mean(q5_14, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q5_14)),
    numNA = sum(is.na(q5_14)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_14, na.rm = TRUE),
    proportion_households = mean(q5_14, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Proportion of respondants reporting bird or bat bitten fruit on the ground in their bari"
)

# During this time of year, do you see tree fruit on the ground bitten by bats or birds? (q5_15)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q5_15)),
    numNA = sum(is.na(q5_15)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_15, na.rm = TRUE),
    proportion_households = mean(q5_15, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q5_15)),
    numNA = sum(is.na(q5_15)),
    response_rate = count / (count + numNA),
    sum_households = sum(q5_15, na.rm = TRUE),
    proportion_households = mean(q5_15, na.rm = TRUE)
  ),
  digits = 3,
  caption = "Proportion of respondants reporting bird or bat bitten fruit on the ground in their bari during this time of year (winter)"
)
  
# In the past month did you ever see large fruit bat in your fruit trees at night? (q6_2_3)
fruit_survey %>%
  summarize(
    count = sum(!is.na(q6_2_3)),
    numNA = sum(is.na(q6_2_3)),
    response_rate = count / (count + numNA),
    sum_households = sum(q6_2_3, na.rm = TRUE),
    proportion_households = mean(q6_2_3, na.rm = TRUE)
  )
kable(fruit_survey %>%
  group_by(case_control_group) %>%
  summarize(
    count = sum(!is.na(q6_2_3)),
    numNA = sum(is.na(q6_2_3)),
    response_rate = count / (count + numNA),
    sum_households = sum(q6_2_3, na.rm = TRUE),
    proportion_households = mean(q6_2_3, na.rm = TRUE)
    ),
  digits = 3,
  caption = "Proportion of respondants reporting seeing large fruit bats in their fruit trees at night"
)

# How often were bats in your fruit trees at night? (q6_3_3)
unique(fruit_survey$q6_3_3)

fruit_survey %>%
  summarize(
    median_household = median(q6_3_3, na.rm = TRUE),
    mean_household = mean(q6_3_3, na.rm = TRUE),
    count = sum(!is.na(q6_3_3)),
    numNA = sum(is.na(q6_3_3)),
    response_rate = count / (count + numNA),
    sum_1 = sum(q6_3_3 == 1, na.rm = TRUE),
    prop_1 = mean(q6_3_3 == 1, na.rm = TRUE),
    sum_2 = sum(q6_3_3 == 2, na.rm = TRUE),
    prop_2 = mean(q6_3_3 == 2, na.rm = TRUE),
    sum_3 = sum(q6_3_3 == 3, na.rm = TRUE),
    prop_3 = mean(q6_3_3 == 3, na.rm = TRUE),
    sum_4 = sum(q6_3_3 == 4, na.rm = TRUE),
    prop_4 = mean(q6_3_3 == 4, na.rm = TRUE)
  )
kable(
  fruit_survey %>%
    group_by(group) %>%
    summarize(
      mean_household = mean(q6_3_3, na.rm = TRUE),
      count = sum(!is.na(q6_3_3)),
      numNA = sum(is.na(q6_3_3)),
      response_rate = count / (count + numNA),
      sum_1 = sum(q6_3_3 == 1, na.rm = TRUE),
      prop_1 = mean(q6_3_3 == 1, na.rm = TRUE),
      sum_2 = sum(q6_3_3 == 2, na.rm = TRUE),
      prop_2 = mean(q6_3_3 == 2, na.rm = TRUE),
      sum_3 = sum(q6_3_3 == 3, na.rm = TRUE),
      prop_3 = mean(q6_3_3 == 3, na.rm = TRUE),
      sum_4 = sum(q6_3_3 == 4, na.rm = TRUE),
      prop_4 = mean(q6_3_3 == 4, na.rm = TRUE)
    ),
  digits = 3,
  caption = "Reported frequency of bari members reporting bats in their fruit trees at night"
)
```

Villagers report commonly seeing dropped fruits that have been bitten by bats or birds. This is highest in case villages at 88%, followed by near controls at 87%, and far controls at 79%. 

Of those who reported that they see fruits on the ground that have been bitten by bats or birds, about 60% reported that it occurs during this time of year (winter). This was highest in case villages, at 71%, followed by near controls at 58% and far controls at 51%. 

Case villagers reported seeing fruit bats in their trees at night the least, at 43%, compared to control villages, both at 52%. 

#### 5. Other information

Number of trees in bari (q5_frt#_5_2)

```{r Number of trees in bari table}
# create some vectors of column names for human dropped fruit consumption
fruit_tree_cols <- paste0("q5_frt", seq(1:31), "_5_2")

# filter survey to just the bari fruit tree columns and rename them with fruit names
fruit_trees <- fruit_survey %>%
  select(case_control_group, all_of(fruit_tree_cols))
colnames(fruit_trees) <- c("case_control_group", fruit_names)

# make a table of bari fruit tree statistics across all villages
fruit_trees_total <- fruit_trees %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(1:124),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(trees_in_bari = value)

# make a table of bari fruit tree statistics grouped by village type
fruit_trees_grouped <- fruit_trees %>%
  group_by(case_control_group) %>%
  summarise(across(all_of(fruit_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(2:125),
               names_sep = "_",
               names_to = c("fruit", "measure")) %>%
  rename(trees_in_bari = value)
```

```{r Number of trees in bari graph, echo = FALSE, fig.height = 5, fig.width = 10}
# create a new object where average numbers across village types is ranked
fruit_trees_grouped_mean <- fruit_trees_grouped %>%
  filter(measure == "mean") %>%
  group_by(fruit) %>%
  mutate(average = mean(trees_in_bari)) %>%
  arrange(desc(average)) %>%
  ungroup() %>%
  mutate(rank = dense_rank(desc(average)))

# pull out the ranked fruit names
fruit_trees_grouped_names <- fruit_trees_grouped_mean %>%
  distinct(fruit) %>%
  pull(fruit)

# plot fruit trees in bari with x-axis ranked by the average
fruit_trees_grouped_mean %>%
  filter(measure == "mean") %>%
  ggplot(aes(x = factor(rank), y = trees_in_bari, color = case_control_group)) +
  geom_jitter(height = 0,
              width = 0.2,
              alpha = 0.8) +
  scale_x_discrete(labels = fruit_trees_grouped_names) +
  labs(x = "Fruit type",
       y = "Number of fruit trees growing\nin or around bari",
       title = "Number of fruit trees growing\naround bari grouped by village type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(vjust = 1)) +
  scale_color_manual(
    name = "Village type",
    values = c(
      "case" = "#E69F00",
      "control, far" = "#56B4E9",
      "control, near" = "#009E73"
    )
  )
```

animal ownership (q4_#_1)

```{r animal ownership table}
# create some vectors of column names for animal ownership
animal_cols <- paste0("q4_", seq(1:8), "_1")

# filter survey to just the animal ownership and rename them with animal names
animals <- fruit_survey %>%
  select(case_control_group, all_of(animal_cols))
colnames(animals) <- c("case_control_group", animal_names)

# make a table of bari animal ownership statistics across all villages
animals_total <- animals %>%
  summarise(across(all_of(animal_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(1:32),
               names_sep = "_",
               names_to = c("animal", "measure")) %>%
  rename(animals_in_bari = value)

# make a table of bari animal ownership statistics grouped by village type
animals_grouped <- animals %>%
  group_by(case_control_group) %>%
  summarise(across(all_of(animal_names),
                   c(mean = mean, sum = sum, count = ~sum(!is.na(.x)), numNA = ~sum(is.na(.x))),
                   na.rm= TRUE)) %>%
  pivot_longer(cols = c(2:33),
               names_sep = "_",
               names_to = c("animal", "measure")) %>%
  rename(animals_in_bari = value)
```

```{r animal ownership graph, echo = FALSE, fig.height = 5, fig.width = 7}
# create a new object where average ownership across village types is ranked
animals_grouped_mean <- animals_grouped %>%
  filter(measure == "mean") %>%
  group_by(animal) %>%
  mutate(average = mean(animals_in_bari)) %>%
  arrange(desc(average)) %>%
  ungroup() %>%
  mutate(rank = dense_rank(desc(average)))

# pull out the ranked animal names
animals_grouped_names <- animals_grouped_mean %>%
  distinct(animal) %>%
  pull(animal)

# plot animals in bari with x-axis ranked by the average
animals_grouped_mean %>%
  filter(measure == "mean") %>%
  ggplot(aes(x = factor(rank), y = animals_in_bari, color = case_control_group)) +
  geom_jitter(height = 0,
              width = 0.2,
              alpha = 0.8) +
  scale_x_discrete(labels = animals_grouped_names) +
  labs(x = "Fruit type",
       y = "Number of animals\nin or around bari",
       title = "Number of animals\nin bari grouped by village type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(vjust = 1)) +
  scale_color_manual(
    name = "Village type",
    values = c(
      "case" = "#E69F00",
      "control, far" = "#56B4E9",
      "control, near" = "#009E73"
    )
  )
```


```{r date palm tree ownership table}
# make a table of date palm tree ownership statistics across all villages
fruit_survey %>%
  summarise(mean = mean(q3_1, na.rm = TRUE),
            sd = sd(q3_1, na.rm = TRUE),
            sum = sum(q3_1, na.rm = TRUE),
            count = sum(!is.na(q3_1), na.rm = TRUE),
            numNA = sum(is.na(q3_1), na.rm = TRUE))

# make a table of date palm tree statistics grouped by village type
fruit_survey %>%
  group_by(case_control_group) %>%
  summarise(mean = mean(q3_1, na.rm = TRUE),
            sd = sd(q3_1, na.rm = TRUE),
            sum = sum(q3_1, na.rm = TRUE),
            count = sum(!is.na(q3_1), na.rm = TRUE),
            numNA = sum(is.na(q3_1), na.rm = TRUE))
```
    